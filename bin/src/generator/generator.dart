import 'dart:convert';
import 'dart:io';

import 'package:code_builder/code_builder.dart';
import 'package:dart_style/dart_style.dart';
import 'package:orm/generator_helper.dart';
import 'package:path/path.dart';

import '../utils/find_project.dart';
import 'client_builder.dart';
import 'dart_style_ignore_builder.dart';
import 'exports_builder.dart';
import 'generator_options.dart';
import 'imports_generator.dart';
import 'model_delegate_builder.dart';
import 'schema/schema_generator.dart';
import 'schema_builder.dart';

/// Resolve output.
String _resolveOutput(EnvValue? output, String schemaPath) {
  if (output == null || output.value.isEmpty) {
    return joinRelativePaths(['lib', 'src', 'generated']);
  }

  return relative(join(dirname(schemaPath), output.value));
}

/// Get generated file.
File _getGeneratedFile(GeneratorOptions options) {
  final String directory =
      _resolveOutput(options.config.output, options.schemaPath);

  final String output =
      directory.substring(directory.length - 5).toLowerCase() == '.dart'
          ? directory
          : join(directory, 'prisma_client.dart');

  final File file = File(output);
  if (file.existsSync()) {
    file.deleteSync();
  }

  return file..createSync(recursive: true);
}

final List<String> _ignores = [
  'constant_identifier_names',
  'non_constant_identifier_names',
]..sort();

/// Run Dart client generator
Future<void> generator(GeneratorOptions options) async {
  final Library library = Library((LibraryBuilder updates) {
    updates.name = 'prisma.client';

    // Add header comment.
    updates.body.add(Code('''\n
// GENERATED CODE - DO NOT MODIFY BY HAND
//
// ignore_for_file: ${_ignores.join(', ')}
//
${'//'.padRight(80, '*')}
// This file was generated by Prisma
// GitHub: https://github.com/odroe/prisma-dart
${'//'.padRight(80, '*')} \n
'''));

    // Export
    updates.directives.add(Directive.export(
      'package:orm/orm.dart',
      show: [
        'Datasource',
        'PrismaNull',
        'PrismaUnion',
      ]..sort(),
    ));

    // Build schema.
    SchemaBuilder(options, updates).build();
  });
  final DartEmitter emitter = DartEmitter.scoped();
  final StringSink sink = library.accept(emitter);
  final DartFormatter formatter = DartFormatter();
  final String formatted = formatter.format(sink.toString());

  // Get output file.
  final File output = _getGeneratedFile(options);

  // Write to file.
  output.writeAsStringSync(formatted);
}
